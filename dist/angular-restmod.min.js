!function(a,b){"use strict";var c=a.module("restmod",["ng","platanus.inflector"]);c.provider("restmod",[function(){return{$get:["RMModelFactory","$log",function(a){var b=Array.prototype.slice,c={model:function(c){var d=a(c);return arguments.length>1&&d.mix(b.call(arguments,1)),d}};return c}]}}]),c.factory("RMCollectionApi",["RMUtils",function(c){var d=a.extend;return{$isCollection:!0,$decode:function(b,d){c.assert(b&&a.isArray(b),"Collection $decode expected array");for(var e=0,f=b.length;f>e;e++)this.$buildRaw(b[e],d).$reveal();return this},$encode:function(a){for(var b=[],c=0,d=this.length;d>c;c++)b.push(this[c].$encode(a));return b},$fetch:function(a){return this.$action(function(){var b={method:"GET",url:this.$url(),params:this.$params};a&&(b.params=b.params?d(b.params,a):a),this.$send(b,function(a){this.$unwrap(a.data)})})},$add:function(a,d){return c.assert(a.$type&&a.$type===this.$type,"Collection $add expects record of the same $type"),this.$action(function(){a.$position===b&&(d!==b?this.splice(d,0,a):this.push(a),a.$position=!0)})}}}]),c.factory("RMCommonApi",["$http","RMFastQ",function(a,c){function d(a,c){var d=a.$dispatcher();return function(e){var f=a.$promise;a.$promise=b;try{a.$last=e;var g=d?a.$decorate(d,c,[a]):c.call(a,a);return g===b?a.$promise:g}finally{a.$promise=f}}}var e={$url:function(){return this.$scope.$urlFor(this)},$dispatcher:function(){return this.$$dsp},$asPromise:function(){var a=this;return this.$promise?this.$promise.then(function(){return a},function(){return c.reject(a)}):c.when(this)},$then:function(a,b){return this.$promise=this.$promise?this.$promise.then(a?d(this,a):a,b?d(this,b):b):c.when(d(this,a)(this)),this},$always:function(a){return this.$then(a,a)},$finally:function(a){return this.$promise=this.$promise["finally"](d(this,a)),this},$send:function(b,e,f){var g=this.$$action;return this.$always(function(){return this.$response=null,this.$status="pending",a(b).then(d(this,function(){g&&g.canceled?this.$status="canceled":(this.$status="ok",this.$response=this.$last,e&&e.call(this,this.$last))}),d(this,function(){return g&&g.canceled?void(this.$status="canceled"):(this.$status="error",this.$response=this.$last,f&&f.call(this,this.$last),c.reject(this))}))})},$action:function(a){var b={canceled:!1},d=this.$pending||(this.$pending=[]);return d.push(b),this.$always(function(){var d=this.$$action;try{return b.canceled?c.reject(this):(this.$$action=b,a.call(this))}finally{this.$$action=d}}).$finally(function(){d.splice(d.indexOf(b),1)})}};return e}]),c.factory("RMExtendedApi",["$q",function(){return{$unwrap:function(a,b){try{return a=this.$type.unpack(this,a),this.$decode(a,b)}finally{}},$wrap:function(a){var b=this.$encode(a);return b=this.$type.pack(this,b)},$resolve:function(a){return this.$action(function(){this.$resolved||this.$fetch(a)})}}}]),c.factory("RMRecordApi",["RMUtils",function(a){var c=function(b,c,d){this.$scope=b,this.$target=c,this.$partial=a.cleanUrl(d)};return c.prototype={$urlFor:function(a){return a.$isCollection||this.$target.isNested()?this.$nestedUrl():this.$target.$urlFor(a)}},{$initialize:function(){this.$super()},$buildUrl:function(c){return this.$pk===b||null===this.$pk?null:a.joinUrl(c.$url(),this.$pk+"")},$decode:function(c,d){return this.$type.decode(this,c,d||a.READ_MASK),(this.$pk===b||null===this.$pk)&&(this.$pk=this.$type.inferKey(c)),this},$encode:function(b){var c=this.$type.encode(this,b||a.CREATE_MASK);return c},$fetch:function(b){return this.$action(function(){var c=this.$url("fetch");a.assert(!!c,"Cant $fetch if resource is not bound");var d={method:"GET",url:c,params:b};this.$send(d,function(a){this.$unwrap(a.data)},function(){})})},$extend:function(a){return this.$action(function(){for(var b in a)a.hasOwnProperty(b)&&"$"!==b[0]&&(this[b]=a[b])})},$save:function(){return this.$action(function(){var c,d=this.$url("update");d?(c={method:"PUT",url:d,data:this.$wrap(a.UPDATE_MASK)},this.$send(c,function(a){this.$unwrap(a.data)},function(){})):(d=this.$url("create")||this.$scope.$url(),a.assert(!!d,"Cant $create if parent scope is not bound"),c={method:"POST",url:d,data:this.$wrap(a.CREATE_MASK)},this.$send(c,function(a){this.$unwrap(a.data),this.$scope.$isCollection&&this.$position===b&&!this.$preventReveal&&this.$scope.$add(this,this.$revealAt)}))})},$destroy:function(){return this.$action(function(){var a=this.$url("destroy");if(a){var b={method:"DELETE",url:a};this.$send(b,function(){})}})},$reveal:function(a){return a===b||a?this.$scope.$add(this,this.$revealAt):this.$preventReveal=!0,this}}}]),c.factory("RMScopeApi",["RMUtils",function(){return{$urlFor:function(a){var b=this.$type.isNested()?this:this.$type;return"function"==typeof a.$buildUrl?a.$buildUrl(b):b.$url()},$build:function(a){return this.$new().$extend(a)},$buildRaw:function(a,b){var c=this.$new(this.$type.inferKey(a));return c.$decode(a,b),c},$find:function(a,b){return this.$new(a).$resolve(b)},$create:function(a){return this.$build(a).$save()},$search:function(a){return this.$collection(a).$fetch()}}}]),c.factory("RMBuilder",[function(){function a(){}return a.prototype={},a}]),c.factory("RMModelFactory",["inflector","$log","RMUtils","RMScopeApi","RMCommonApi","RMRecordApi","RMCollectionApi","RMExtendedApi","RMSerializer","RMBuilder",function(b,c,d,e,f,g,h,i,j,k){var l=/(.*?)([^\/]+)\/?$/,m=d.extendOverriden;return function(c){function n(a,b){this.$scope=a||n,this.$pk=b,this.$initialize()}function o(a,b){var c=new u;return c.$scope=b||n,c.$params=a,c}c=d.cleanUrl(c);var p,q={primaryKey:"id",urlPrefix:null},r=new j(n),s=[],t=[];!q.name&&c&&(q.name=b.singularize(c.replace(l,"$2")));var u=d.buildArrayType(),v=d.buildArrayType();m(n,{$$chain:[],$type:n,$new:function(a,b){return new n(b||n,a)},$collection:o,$url:function(){return q.urlPrefix?d.joinUrl(q.urlPrefix,c):c},inferKey:function(a){return a&&"undefined"!=typeof a[q.primaryKey]?a[q.primaryKey]:null},isNested:function(){return!c},unpack:function(a,b){return b},pack:function(a,b){return b},decode:r.decode,encode:r.encode,decodeName:null,encodeName:null},e),m(n.prototype,{$type:n,$initialize:function(){var a,b,c=this;for(b=0;a=s[b];b++)this[a[0]]="function"==typeof a[1]?a[1].apply(this):a[1];for(b=0;a=t[b];b++)Object.defineProperty(c,a[0],{enumerable:!0,get:a[1]})}},f,g,i),m(u.prototype,{$type:n,$new:function(a,b){return n.$new(a,b||this)},$collection:function(b,c){return b=this.$params?a.extend({},this.$params,b):b,o(b,c||this.$scope)}},e,f,h,i);({Model:n,Record:n.prototype,Collection:u.prototype,List:v.prototype});return p=new k,n}}]),c.factory("RMFastQ",[function(){function b(a,f){return a&&d(a.then)?c(a):{simple:!0,then:function(c,d){return b(f?d(a):c(a))},"catch":e,"finally":function(e){var g=e();return g&&d(a.then)?c(a.then(function(){return f?b(a,!0):a},function(){return f?b(a,!0):a})):this}}}function c(a){if(a.simple)return a;var d;return a.then(function(a){d=b(a)},function(a){d=b(a,!0)}),{then:function(b,e){return d?d.then(b,e):c(a.then(b,e))},"catch":e,"finally":function(b){return d?d["finally"](b):c(a["finally"](b))}}}var d=a.isFunction,e=function(a){return this.then(null,a)};return{reject:function(a){return b(a,!0)},when:function(a){return b(a,!1)},wrap:c}}]),c.factory("RMSerializer",["$filter","RMUtils",function(){function c(a,b){for(var c,d=0;a&&(c=b[d]);d++)a=a[c];return a}function d(a,b,c){for(var d=0,e=b.length-1;e>d;d++){var f=b[d];a=a[f]||(a[f]={})}a[b[b.length-1]]=c}return function(e){function f(a,b){if("function"==typeof b)return b(a);var c=l[a];return c&&(c===!0||-1!==c.indexOf(b))}function g(a,d,g,i,j){var k,l,m,n,q,r,s,t,u=g?g+".":"";if(q=p[g])for(s=0,t=q.length;t>s;s++)m=u+q[s].path,f(m,i)||(n=q[s].map?c(a,q[s].map):a[e.encodeName?e.encodeName(q[s].path):q[s].path],(q[s].forced||n!==b)&&(n=h(n,m,i,j),n!==b&&(d[q[s].path]=n)));for(k in a)if(a.hasOwnProperty(k)){if(l=e.decodeName?e.decodeName(k):k,"$"===l[0])continue;if(q){for(r=!1,s=0,t=q.length;t>s&&!(r=q[s].mapPath===k);s++);if(r)continue}if(m=u+l,o[m]||f(m,i))continue;n=h(a[k],m,i,j),n!==b&&(d[l]=n)}}function h(a,b,c,d){var e=m[b],f=a;if(e)f=e.call(d,a);else if("object"==typeof a)if(k(a)){f=[];for(var i=0,j=a.length;j>i;i++)f.push(h(a[i],b+"[]",c,d))}else a&&(f={},g(a,f,b,c,d));return f}function i(a,c,g,h,i){var k,l,m,n,r,s=g?g+".":"";for(k in a)if(a.hasOwnProperty(k)&&"$"!==k[0]){if(l=s+k,o[l]||f(l,h))continue;n=j(a[k],l,h,i),n!==b&&(m=e.encodeName?e.encodeName(k):k,c[m]=n),q[l]&&delete a[k]}if(r=p[g])for(var t=0,u=r.length;u>t;t++)l=s+r[t].path,f(l,h)||(n=a[r[t].path],(r[t].forced||n!==b)&&(n=j(n,l,h,i),n!==b&&(r[t].map?d(c,r[t].map,n):c[e.encodeName?e.encodeName(r[t].path):r[t].path]=n)))}function j(a,b,c,d){var e=n[b],f=a;if(e)f=e.call(d,a);else if(null!==a&&"object"==typeof a&&"function"!=typeof a.toJSON)if(k(a)){f=[];for(var g=0,h=a.length;h>g;g++)f.push(j(a[g],b+"[]",c,d))}else a&&(f={},i(a,f,b,c,d));return f}var k=a.isArray,l={},m={},n={},o={},p={},q={};return{decode:function(a,b,c){g(b,a,"",c,a)},encode:function(a,b){var c={};return i(a,c,"",b,a),c}}}}]),c.factory("RMUtils",["$log",function(a){var b=function(){var a=function(){};return Object.setPrototypeOf?function(a,b){Object.setPrototypeOf(a,b)}:(new a).__proto__===a.prototype?function(a,b){a.__proto__=b}:void 0}(),c={CREATE_MASK:"C",UPDATE_MASK:"U",READ_MASK:"R",assert:function(b,c){if(!b){{Array.prototype.slice.call(arguments,2)}throw a.error(c),new Error(c)}},joinUrl:function(a,b){return a&&b?(a+"").replace(/\/$/,"")+"/"+(b+"").replace(/^\//,""):null},cleanUrl:function(a){return a?a.replace(/\/$/,""):a},override:function(a,b){return a&&"function"==typeof b?function(){var c=this.$super;try{return this.$super=a,b.apply(this,arguments)}finally{this.$super=c}}:b},extendOverriden:function(a){for(var b=1;b<arguments.length;b++){var d=arguments[b];for(var e in d)d.hasOwnProperty(e)&&(a[e]=a[e]&&"function"==typeof a[e]?c.override(a[e],d[e]):d[e])}return a},buildArrayType:function(){var a,c=function(){var a=[];return a.push.apply(a,arguments),b(a,c.prototype),a};return c.prototype=[],c.prototype.last=function(){return this[this.length-1]},a=c}};return c}])}(angular);